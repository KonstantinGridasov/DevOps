name: UPDATE
env:
  EB_APPLICATION_NAME       : "tryon"
  AWS_REGION_NAME           : "us-east-1"
  AWS_INSTANCE_TYPE         : "t2.micro"

on:
  push:
    branches-ignore:
      - master
  create:

jobs:
  my_ci_part:
    runs-on: ubuntu-latest
    steps:

      - name: Git clone our repo
        uses: actions/checkout@v1

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v1
        with:
          aws-access-key-id: ${{ secrets.MY_AWS_ACCESS_KEY }}
          aws-secret-access-key: ${{ secrets.MY_AWS_SECRET_KEY }}
          aws-region: ${{ env.AWS_REGION_NAME }}

      - name: Get EB CLI version
        run: |
          python -m pip install --upgrade pip
          pip install awsebcli --upgrade

      - name: Initilazed CLI
        run: eb init ${{ env.EB_APPLICATION_NAME }}-${GITHUB_REF##*/}-app -p "64bit Amazon Linux 2 v3.3.8 running Python 3.8" --region ${{ env.AWS_REGION_NAME }}

      - name: Create envrinment by CLI
        if: ${{ github.event_name == 'create'}}
        run: eb create ${{ env.EB_APPLICATION_NAME }}-${GITHUB_REF##*/}-env -it ${{ env.AWS_INSTANCE_TYPE }} --single

      - name: Deploy new ElasticBeanstalk Application Version
        run: eb deploy

      - name: Finished
        run: eb status